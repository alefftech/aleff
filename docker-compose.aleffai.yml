# =============================================================================
# [COMPOSE:MAIN] AleffAI - Production Stack (dev-04)
# =============================================================================
#
# Usage:
#   docker compose -f docker-compose.aleffai.yml up -d
#   docker compose -f docker-compose.aleffai.yml logs -f aleffai
#
# Architecture:
#   aleffai (gateway:18789) â†’ postgres (pgvector:5432)
#   Access via VPN: aleffai.abckx.corp (Traefik)
#
# =============================================================================

services:
  # ===========================================================================
  # [COMPOSE:POSTGRES] PostgreSQL with pgvector for Aleff Memory
  # ===========================================================================
  postgres:
    container_name: aleff-postgres
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_USER: aleff
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-aleff_local_2026}
      POSTGRES_DB: aleff_memory
    volumes:
      - ${POSTGRES_DATA_PATH:-aleff_postgres_data}:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aleff -d aleff_memory"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default

  # ===========================================================================
  # [COMPOSE:ALEFFAI] Moltbot Gateway with Aleff Memory Plugin
  # ===========================================================================
  aleffai:
    container_name: aleffai
    image: ${ALEFFAI_IMAGE:-aleffai:latest}
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    # Port exposed only via Traefik (no external binding)
    env_file:
      - .env
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - NODE_ENV=production
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN:-aleff-gateway-secure-2026}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=aleff
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-aleff_local_2026}
      - POSTGRES_DB=aleff_memory
      - DATABASE_URL=postgresql://aleff:${POSTGRES_PASSWORD:-aleff_local_2026}@postgres:5432/aleff_memory
      - GOG_KEYRING_PASSWORD=${GOG_KEYRING_PASSWORD:-aleff2026secure}
    volumes:
      - ./data:/home/node/.moltbot:rw
      - ./clawdbot:/home/node/.clawdbot:rw
      - ./gogcli:/home/node/.config/gogcli:rw
    labels:
      # [TRAEFIK:ROUTER] Route aleffai.abckx.corp to this container
      - "traefik.enable=true"
      - "traefik.http.routers.aleffai.rule=Host(`aleffai.abckx.corp`)"
      - "traefik.http.routers.aleffai.entrypoints=websecure"
      - "traefik.http.routers.aleffai.tls=true"
      - "traefik.http.services.aleffai.loadbalancer.server.port=18789"
      # [TRAEFIK:WS] WebSocket support
      - "traefik.http.middlewares.aleffai-ws.headers.customrequestheaders.Connection=upgrade"
      - "traefik.http.middlewares.aleffai-ws.headers.customrequestheaders.Upgrade=websocket"
      - "traefik.http.routers.aleffai.middlewares=aleffai-ws"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    command:
      - node
      - dist/index.js
      - gateway
      - --bind
      - "lan"
      - --port
      - "18789"
    networks:
      - default
      - traefik-public

# =============================================================================
# [COMPOSE:VOLUMES] Named Volumes
# =============================================================================
volumes:
  aleff_postgres_data:
    name: aleff_postgres_data

# =============================================================================
# [COMPOSE:NETWORKS] Network Configuration
# =============================================================================
networks:
  default:
    name: aleff_default
  traefik-public:
    external: true
