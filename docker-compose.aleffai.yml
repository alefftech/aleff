# =============================================================================
# [COMPOSE:MAIN] AleffAI - Production Stack
# =============================================================================
#
# Usage:
#   docker compose -f docker-compose.aleffai.yml up -d
#   docker compose -f docker-compose.aleffai.yml logs -f aleffai
#   docker compose -f docker-compose.aleffai.yml down
#
# Requirements:
#   - .env file with API keys (see .env.example)
#   - init-db.sql file for database schema
#
# Quick Start:
#   1. cp .env.example .env
#   2. Edit .env with your API keys
#   3. docker compose -f docker-compose.aleff.yml up -d
#
# Architecture:
#   aleffai (gateway:18789) â†’ postgres (pgvector:5432)
#
# Portability:
#   - Uses named volumes (no hardcoded paths)
#   - Works on any Docker host
#   - Optional Traefik integration (set ENABLE_TRAEFIK=true)
#
# =============================================================================

services:
  # ===========================================================================
  # [COMPOSE:POSTGRES] PostgreSQL with pgvector for Aleff Memory
  # ===========================================================================
  postgres:
    container_name: aleff-postgres
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_USER: aleff
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-aleff_local_2026}
      POSTGRES_DB: aleff_memory
    volumes:
      # [VOL:DATA] PostgreSQL data - uses named volume for portability
      # Override with POSTGRES_DATA_PATH env var for custom path
      - ${POSTGRES_DATA_PATH:-aleff_postgres_data}:/var/lib/postgresql/data
      # [VOL:INIT] Schema initialization
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aleff -d aleff_memory"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - default

  # ===========================================================================
  # [COMPOSE:ALEFFAI] Moltbot Gateway with Aleff Memory Plugin
  # ===========================================================================
  aleffai:
    container_name: aleffai
    # [BUILD:IMAGE] Build from local Dockerfile or use pre-built
    image: ${ALEFFAI_IMAGE:-aleffai:latest}
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${GATEWAY_PORT:-18789}:18789"
    env_file:
      - .env
    environment:
      # [ENV:CORE] Core API Keys (from .env)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - NODE_ENV=production

      # [ENV:GATEWAY] Gateway Authentication
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN:-aleff-gateway-secure-2026}

      # [ENV:DATABASE] PostgreSQL for Aleff Memory
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=aleff
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-aleff_local_2026}
      - POSTGRES_DB=aleff_memory
      - DATABASE_URL=postgresql://aleff:${POSTGRES_PASSWORD:-aleff_local_2026}@postgres:5432/aleff_memory

      # [ENV:INTEGRATIONS] Google OAuth for gog CLI
      - GOG_KEYRING_PASSWORD=${GOG_KEYRING_PASSWORD:-aleff2026secure}
    volumes:
      # [VOL:CONFIG] Moltbot configuration and state
      - ./data:/home/node/.moltbot:rw
      # [VOL:CLAWDBOT] Agent credentials and OAuth tokens
      - ./clawdbot:/home/node/.clawdbot:rw
      # [VOL:GOGCLI] Google OAuth credentials
      - ./gogcli:/home/node/.config/gogcli:rw
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    command:
      - node
      - dist/index.js
      - gateway
      - --bind
      - "lan"
      - --port
      - "18789"
    networks:
      - default

# =============================================================================
# [COMPOSE:VOLUMES] Named Volumes (portable across hosts)
# =============================================================================
volumes:
  aleff_postgres_data:
    name: aleff_postgres_data

# =============================================================================
# [COMPOSE:NETWORKS] Network Configuration
# =============================================================================
networks:
  default:
    name: aleff_default
